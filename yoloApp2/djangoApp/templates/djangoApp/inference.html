<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>推論実行ワークスペース</title>
        <style>
            :root {
                color-scheme: dark;
                --bg: radial-gradient(circle at top, #050816, #020411 65%);
                --panel: rgba(11, 15, 31, 0.92);
                --card: rgba(17, 23, 46, 0.85);
                --muted: #cbd5f5;
                --text: #f8fafc;
                --accent: #22d3ee;
                --accent-soft: rgba(34, 211, 238, 0.12);
                --border: rgba(148, 163, 184, 0.25);
                --danger: #fb7185;
                --warning: #fcd34d;
                --success: #34d399;
            }

            * {
                box-sizing: border-box;
            }

            body {
                margin: 0;
                min-height: 100vh;
                font-family: "Noto Sans JP", "Hiragino Sans", system-ui, -apple-system, sans-serif;
                background: var(--bg);
                color: var(--text);
                padding-bottom: 2rem;
            }

            header {
                padding: 2.5rem 2rem 1.5rem;
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                align-items: flex-end;
                justify-content: space-between;
            }

            header h1 {
                margin: 0.3rem 0 0;
                font-size: clamp(1.8rem, 4vw, 2.6rem);
            }

            header p {
                margin: 0.2rem 0 0;
                color: var(--muted);
                max-width: 640px;
                line-height: 1.6;
            }

            header nav a {
                color: var(--muted);
                text-decoration: none;
            }

            .tagline {
                display: inline-flex;
                align-items: center;
                gap: 0.4rem;
                letter-spacing: 0.08em;
                font-size: 0.9rem;
                color: var(--accent);
                padding: 0.25rem 0.8rem;
                border: 1px solid rgba(34, 211, 238, 0.4);
                border-radius: 999px;
                background: rgba(34, 211, 238, 0.1);
                text-transform: uppercase;
            }

            .layout {
                display: grid;
                grid-template-columns: minmax(320px, 360px) minmax(0, 1fr);
                gap: 1.5rem;
                padding: 0 2rem;
            }

            .panel {
                background: var(--panel);
                border: 1px solid var(--border);
                border-radius: 1.2rem;
                padding: 1.5rem;
                box-shadow: 0 30px 80px rgba(3, 7, 18, 0.55);
                backdrop-filter: blur(18px);
            }

            .panel h2 {
                margin: 0;
                font-size: 1.2rem;
            }

            .panel + .panel {
                margin-top: 1.5rem;
            }

            .panel small {
                color: var(--muted);
            }

            .control-stack {
                display: flex;
                flex-direction: column;
            }

            .status-chip {
                display: inline-flex;
                align-items: center;
                gap: 0.3rem;
                padding: 0.25rem 0.7rem;
                border-radius: 999px;
                font-size: 0.85rem;
                color: var(--text);
            }

            .status-idle {
                background: rgba(148, 163, 184, 0.2);
            }

            .status-ready {
                background: rgba(52, 211, 153, 0.2);
                color: var(--success);
            }

            .status-running {
                background: rgba(252, 211, 77, 0.18);
                color: var(--warning);
            }

            .status-error {
                background: rgba(251, 113, 133, 0.18);
                color: var(--danger);
            }

            .dropzone {
                border: 1px dashed var(--border);
                border-radius: 1rem;
                padding: 1.5rem;
                text-align: center;
                margin-top: 1rem;
                background: rgba(2, 6, 23, 0.4);
                transition: border 0.2s ease, background 0.2s ease;
            }

            .dropzone:hover,
            .dropzone.is-dragover {
                border-color: var(--accent);
                background: rgba(34, 211, 238, 0.08);
            }

            .dropzone h3 {
                margin: 0.6rem 0 0.3rem;
            }

            .dropzone p {
                margin: 0;
                color: var(--muted);
            }

            .model-info {
                margin-top: 1rem;
                padding: 1rem;
                border-radius: 0.9rem;
                background: rgba(34, 211, 238, 0.08);
                border: 1px solid rgba(34, 211, 238, 0.25);
                display: none;
            }

            .model-info.is-visible {
                display: block;
            }

            .settings-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 1rem;
                margin-top: 1rem;
            }

            .form-field label {
                display: flex;
                justify-content: space-between;
                font-size: 0.85rem;
                color: var(--muted);
                margin-bottom: 0.3rem;
            }

            .form-field input {
                width: 100%;
                border-radius: 0.7rem;
                border: 1px solid rgba(148, 163, 184, 0.4);
                background: rgba(15, 23, 42, 0.9);
                color: var(--text);
                padding: 0.65rem;
            }

            button,
            .btn {
                border: none;
                border-radius: 0.9rem;
                padding: 0.75rem 1.2rem;
                font-weight: 600;
                cursor: pointer;
                transition: transform 0.15s ease, box-shadow 0.15s ease;
            }

            button:hover,
            .btn:hover {
                transform: translateY(-2px);
            }

            .btn-primary {
                background: var(--accent);
                color: #02121c;
                box-shadow: 0 15px 30px rgba(34, 211, 238, 0.3);
            }

            button:disabled,
            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                box-shadow: none;
            }

            .btn-outline {
                background: transparent;
                color: var(--text);
                border: 1px solid rgba(148, 163, 184, 0.5);
            }

            .actions {
                margin-top: 1.5rem;
                display: flex;
                gap: 0.8rem;
                flex-wrap: wrap;
            }

            .workspace {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                min-height: 0;
            }

            .workspace-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .workspace-header h2 {
                margin: 0;
            }

            .counter-badge {
                background: rgba(148, 163, 184, 0.2);
                color: var(--muted);
                border-radius: 999px;
                padding: 0.2rem 0.8rem;
                font-size: 0.85rem;
            }

            .image-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
                gap: 1rem;
            }

            .image-card {
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 1rem;
                padding: 1rem;
                display: flex;
                flex-direction: column;
                gap: 0.8rem;
            }

            .image-card header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.9rem;
            }

            .image-preview {
                position: relative;
                border-radius: 0.9rem;
                overflow: hidden;
                border: 1px solid rgba(148, 163, 184, 0.35);
                min-height: 180px;
            }

            .image-preview img {
                width: 100%;
                display: block;
            }

            .preview-overlay {
                position: absolute;
                inset: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--muted);
                font-size: 0.9rem;
                background: linear-gradient(135deg, rgba(2, 6, 23, 0.75), rgba(15, 23, 42, 0.5));
                text-align: center;
                padding: 1rem;
                opacity: 0;
                transition: opacity 0.2s ease;
            }

            .image-preview.is-pending .preview-overlay,
            .image-preview.is-running .preview-overlay,
            .image-preview.is-error .preview-overlay {
                opacity: 1;
            }

            .image-preview.is-running .preview-overlay {
                background: linear-gradient(135deg, rgba(120, 53, 15, 0.85), rgba(180, 83, 9, 0.65));
            }

            .image-preview.is-error .preview-overlay {
                background: linear-gradient(135deg, rgba(127, 29, 29, 0.9), rgba(190, 18, 60, 0.6));
            }

            .result-list {
                margin: 0;
                padding-left: 1.1rem;
                color: var(--muted);
                font-size: 0.9rem;
            }

            .result-list li + li {
                margin-top: 0.3rem;
            }

            .result-chip {
                display: inline-flex;
                align-items: center;
                gap: 0.4rem;
                padding: 0.15rem 0.5rem;
                border-radius: 0.8rem;
                background: rgba(34, 211, 238, 0.12);
                border: 1px solid rgba(34, 211, 238, 0.2);
                color: var(--text);
                font-size: 0.85rem;
                margin-right: 0.25rem;
            }

            .result-meta {
                color: var(--muted);
                font-size: 0.85rem;
            }

            .result-empty {
                color: var(--muted);
                font-size: 0.9rem;
                margin: 0;
            }

            .result-error {
                color: var(--danger);
                font-size: 0.9rem;
                margin: 0;
            }

            .card-actions {
                display: flex;
                justify-content: flex-end;
            }

            .log-list {
                margin: 1rem 0 0;
                padding-left: 1.2rem;
                font-size: 0.92rem;
                color: var(--muted);
                max-height: 180px;
                overflow: auto;
            }

            .log-list li {
                margin-bottom: 0.6rem;
            }

            .log-title {
                color: var(--text);
                font-weight: 600;
            }

            .log-meta {
                display: block;
                font-size: 0.8rem;
                color: var(--muted);
            }

            .toast {
                position: fixed;
                bottom: 1.5rem;
                left: 50%;
                transform: translate(-50%, 120%);
                background: rgba(2, 10, 25, 0.9);
                border: 1px solid rgba(34, 211, 238, 0.4);
                padding: 0.8rem 1.2rem;
                border-radius: 999px;
                opacity: 0;
                color: var(--text);
                transition: opacity 0.3s ease, transform 0.3s ease;
            }

            .toast.is-visible {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            .toast.is-error {
                border-color: rgba(251, 113, 133, 0.7);
                color: var(--danger);
            }

            @media (max-width: 960px) {
                header {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .layout {
                    grid-template-columns: 1fr;
                    padding: 0 1.25rem;
                }
            }
        </style>
    </head>
    <body>
        <header>
            <div>
                <span class="tagline">YOLO Inference Console</span>
                <h1>推論実行ワークスペース</h1>
                <p>
                    学習済みモデル(.pt)を読み込み、推論画像をまとめて登録し、設定を調整しながら本番と同じYOLOv9エンジンで推論を実行できます。
                    結果はブラウザ上で即座に可視化され、検出ログや動作デバイスも記録されます。
                </p>
            </div>
            <nav>
                <a href="{% url 'home' %}">← ホームに戻る</a>
            </nav>
        </header>

        <div class="layout">
            <div class="control-stack">
                <section class="panel">
                    <div class="section-header">
                        <h2>モデルインポート</h2>
                        <span id="modelStatus" class="status-chip status-idle">モデル未読込</span>
                    </div>
                    <small>Google Colabで学習した.ptファイルを登録してください。</small>
                    <div class="dropzone" id="modelDropzone">
                        <input id="modelInput" type="file" accept=".pt" hidden />
                        <p class="counter-badge">.ptファイルに対応</p>
                        <h3>モデルファイルをドラッグ&ドロップ</h3>
                        <p>またはここをクリックしてファイルを選択</p>
                    </div>
                    <div class="model-info" id="modelInfo"></div>
                </section>

                <section class="panel">
                    <div class="section-header">
                        <h2>推論設定</h2>
                    </div>
                    <small>各設定値は推論実行時に適用されます。</small>
                    <form id="settingsForm">
                        <div class="settings-grid">
                            <div class="form-field">
                                <label for="imgSize">
                                    img_size
                                    <span>px</span>
                                </label>
                                <input id="imgSize" name="img_size" type="number" min="32" max="2048" step="32" value="640" />
                            </div>
                            <div class="form-field">
                                <label for="numWorkers">
                                    num_workers
                                    <span>CPU</span>
                                </label>
                                <input id="numWorkers" name="num_workers" type="number" min="1" max="32" value="4" />
                            </div>
                            <div class="form-field">
                                <label for="minConfidence">
                                    min_confidence
                                    <span>0–1</span>
                                </label>
                                <input
                                    id="minConfidence"
                                    name="min_confidence"
                                    type="number"
                                    min="0"
                                    max="1"
                                    step="0.01"
                                    value="0.25"
                                />
                            </div>
                            <div class="form-field">
                                <label for="minIou">
                                    min_iou
                                    <span>0–1</span>
                                </label>
                                <input id="minIou" name="min_iou" type="number" min="0" max="1" step="0.01" value="0.45" />
                            </div>
                            <div class="form-field">
                                <label for="maxBbox">
                                    max_bbox
                                    <span>/img</span>
                                </label>
                                <input id="maxBbox" name="max_bbox" type="number" min="1" max="1000" value="300" />
                            </div>
                        </div>
                    </form>
                    <div class="actions">
                        <button class="btn-primary" type="button" id="runInference">推論開始</button>
                        <button class="btn-outline" type="button" id="resetWorkspace">入力をリセット</button>
                    </div>
                </section>

                <section class="panel">
                    <div class="section-header">
                        <h2>実行メモ</h2>
                    </div>
                    <small>最新の設定やノートを確認できます。</small>
                    <ol class="log-list" id="runLog"></ol>
                </section>
            </div>

            <section class="panel workspace">
                <div class="workspace-header">
                    <div>
                        <h2>推論画像</h2>
                        <small>複数枚まとめて登録できます。</small>
                    </div>
                    <span class="counter-badge" id="imageCounter">0枚</span>
                </div>
                <div class="dropzone" id="imageDropzone">
                    <input id="imageInput" type="file" accept="image/*" multiple hidden />
                    <p class="counter-badge">JPEG / PNGなど</p>
                    <h3>推論したい画像を追加</h3>
                    <p>ここにドロップ、またはクリックしてファイルを選択</p>
                </div>
                <div class="image-grid" id="imageGrid">
                    <div class="image-card">
                        <p class="result-empty">
                            まだ画像がありません。モデルと設定を準備したらここに推論候補が表示されます。
                        </p>
                    </div>
                </div>
            </section>
        </div>

        <div class="toast" id="toast" role="status" aria-live="polite"></div>

        <script>
            (() => {
                const RUN_ENDPOINT = "{% url 'run_inference' %}";
                const MAX_IMAGES = 24;

                const state = {
                    model: null,
                    images: [],
                    settings: {
                        img_size: 640,
                        num_workers: 4,
                        min_confidence: 0.25,
                        min_iou: 0.45,
                        max_bbox: 300,
                    },
                    logs: [],
                    classNames: [],
                    lastStats: null,
                    lastDevice: "",
                    isRunning: false,
                };

                const elements = {
                    toast: document.getElementById("toast"),
                    modelInput: document.getElementById("modelInput"),
                    modelDropzone: document.getElementById("modelDropzone"),
                    modelStatus: document.getElementById("modelStatus"),
                    modelInfo: document.getElementById("modelInfo"),
                    imageInput: document.getElementById("imageInput"),
                    imageDropzone: document.getElementById("imageDropzone"),
                    imageGrid: document.getElementById("imageGrid"),
                    imageCounter: document.getElementById("imageCounter"),
                    settingsForm: document.getElementById("settingsForm"),
                    runLog: document.getElementById("runLog"),
                    runBtn: document.getElementById("runInference"),
                    resetBtn: document.getElementById("resetWorkspace"),
                };

                let toastTimer = null;

                const uuid = () => crypto.randomUUID?.() ?? `id-${Date.now()}-${Math.random()}`;

                const formatBytes = (bytes) => {
                    if (!Number.isFinite(bytes)) return "-";
                    if (bytes === 0) return "0 B";
                    const units = ['B', 'KB', 'MB', 'GB'];
                    const index = Math.min(units.length - 1, Math.floor(Math.log(bytes) / Math.log(1024)));
                    return `${(bytes / 1024 ** index).toFixed(1)} ${units[index]}`;
                };

                const formatPercent = (value) => `${(Number(value) * 100).toFixed(1)}%`;

                const showToast = (message, isError = false) => {
                    elements.toast.textContent = message;
                    elements.toast.classList.toggle('is-error', Boolean(isError));
                    elements.toast.classList.add('is-visible');
                    clearTimeout(toastTimer);
                    toastTimer = setTimeout(() => elements.toast.classList.remove('is-visible'), 2800);
                };

                const updateSettings = () => {
                    const formData = new FormData(elements.settingsForm);
                    Object.keys(state.settings).forEach((key) => {
                        const value = formData.get(key);
                        if (value !== null) {
                            const num = Number(value);
                            state.settings[key] = Number.isFinite(num) ? num : value;
                        }
                    });
                };

                const renderModelInfo = () => {
                    const { modelStatus, modelInfo } = elements;
                    if (!state.model) {
                        modelStatus.textContent = 'モデル未読込';
                        modelStatus.className = 'status-chip status-idle';
                        modelInfo.classList.remove('is-visible');
                        modelInfo.innerHTML = '';
                        return;
                    }

                    modelStatus.textContent = state.isRunning ? 'モデル使用中' : 'モデル読込済み';
                    modelStatus.className = `status-chip ${state.isRunning ? 'status-running' : 'status-ready'}`;
                    const { name, size, importedAt } = state.model;
                    const classesInfo = state.classNames.length
                        ? `<p style="margin:0.2rem 0 0;color:var(--muted);">検出クラス: ${state.classNames.join(', ')}</p>`
                        : '';
                    const stats = state.lastStats;
                    const statsInfo = stats
                        ? `<p style="margin:0.2rem 0 0;color:var(--muted);">前回: ${stats.total_images ?? 0}枚 / ${
                              stats.total_detections ?? 0
                          }件 / ${(Number(stats.total_time_ms ?? 0)).toFixed(1)}ms${state.lastDevice ? ` / Device: ${state.lastDevice}` : ''}</p>`
                        : '';
                    modelInfo.classList.add('is-visible');
                    modelInfo.innerHTML = `
                        <strong>${name}</strong>
                        <p style="margin:0.4rem 0 0.2rem;">サイズ: ${formatBytes(size)}</p>
                        <p style="margin:0;color:var(--muted);">読込時刻: ${importedAt.toLocaleString()}</p>
                        ${classesInfo}
                        ${statsInfo}
                    `;
                };

                const renderLogs = () => {
                    if (!state.logs.length) {
                        elements.runLog.innerHTML = '<li style="color:var(--muted);">推論履歴はまだありません。</li>';
                        return;
                    }
                    elements.runLog.innerHTML = state.logs
                        .map(
                            (log) =>
                                `<li><span class="log-title">${log.title}</span><span class="log-meta">${log.meta}</span></li>`,
                        )
                        .join('');
                };

                const getStatusClass = (status) => {
                    switch (status) {
                        case 'running':
                            return 'status-running';
                        case 'completed':
                            return 'status-ready';
                        case 'error':
                            return 'status-error';
                        default:
                            return 'status-idle';
                    }
                };

                const getStatusLabel = (image) => {
                    if (image.status === 'running') return '推論中';
                    if (image.status === 'completed') {
                        return image.numDetections ? `${image.numDetections}件検出` : '検出なし';
                    }
                    if (image.status === 'error') return 'エラー';
                    return '未推論';
                };

                const getOverlayText = (status) => {
                    if (status === 'running') return '推論中...';
                    if (status === 'error') return '推論に失敗しました';
                    if (status === 'pending') return '推論待ち';
                    return '';
                };

                const renderImageGrid = () => {
                    elements.imageGrid.innerHTML = '';
                    elements.imageCounter.textContent = `${state.images.length}枚`;
                    if (!state.images.length) {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-card';
                        placeholder.innerHTML = '<p class="result-empty">画像を登録するとここに一覧が表示されます。</p>';
                        elements.imageGrid.appendChild(placeholder);
                        return;
                    }

                    state.images.forEach((image) => {
                        const card = document.createElement('article');
                        card.className = 'image-card';

                        const header = document.createElement('header');
                        const title = document.createElement('div');
                        title.innerHTML = `<strong>${image.name}</strong><br/><span style="color:var(--muted)">${formatBytes(
                            image.size,
                        )}</span>`;
                        const chip = document.createElement('span');
                        chip.className = `status-chip ${getStatusClass(image.status)}`;
                        chip.textContent = getStatusLabel(image);
                        header.appendChild(title);
                        header.appendChild(chip);
                        card.appendChild(header);

                        const preview = document.createElement('div');
                        preview.className = 'image-preview';
                        if (image.status === 'pending') preview.classList.add('is-pending');
                        if (image.status === 'running') preview.classList.add('is-running');
                        if (image.status === 'error') preview.classList.add('is-error');
                        const imgEl = document.createElement('img');
                        imgEl.src = image.resultImage || image.previewSrc;
                        imgEl.alt = image.name;
                        preview.appendChild(imgEl);
                        const overlay = document.createElement('div');
                        overlay.className = 'preview-overlay';
                        overlay.textContent = getOverlayText(image.status);
                        preview.appendChild(overlay);
                        card.appendChild(preview);

                        let bodyContent = '';
                        if (image.status === 'error') {
                            bodyContent = `<p class="result-error">${image.error || '推論に失敗しました'}</p>`;
                        } else if (image.results?.length) {
                            const rows = image.results
                                .map((result) => {
                                    const bbox = result.bbox || {};
                                    return `<li>
                                        <span class="result-chip">${result.class_name ?? result.class_id}</span>
                                        <span class="result-meta">${formatPercent(result.confidence ?? 0)} / (${Math.round(
                                        bbox.x1 ?? 0,
                                    )}, ${Math.round(bbox.y1 ?? 0)})→(${Math.round(bbox.x2 ?? 0)}, ${Math.round(
                                        bbox.y2 ?? 0,
                                    )})</span>
                                    </li>`;
                                })
                                .join('');
                            bodyContent = `<ul class="result-list">${rows}</ul>`;
                        } else if (image.status === 'completed') {
                            bodyContent = '<p class="result-empty">検出は見つかりませんでした。</p>';
                        } else {
                            bodyContent = '<p class="result-empty">推論待ちです。</p>';
                        }
                        const info = document.createElement('div');
                        info.innerHTML = bodyContent;
                        card.appendChild(info);

                        const actions = document.createElement('div');
                            actions.className = 'card-actions';
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'btn-outline';
                        downloadBtn.textContent = '結果画像を保存';
                        downloadBtn.disabled = !image.resultImage;
                        downloadBtn.addEventListener('click', () => downloadImage(image));
                        actions.appendChild(downloadBtn);
                        card.appendChild(actions);

                        elements.imageGrid.appendChild(card);
                    });
                };

                const handleModelFiles = (files) => {
                    if (!files.length) return;
                    const file = files[0];
                    if (!file.name.toLowerCase().endsWith('.pt')) {
                        showToast('拡張子が .pt のモデルファイルを指定してください。', true);
                        return;
                    }
                    state.model = {
                        id: uuid(),
                        name: file.name,
                        size: file.size,
                        file,
                        importedAt: new Date(),
                    };
                    renderModelInfo();
                    showToast('モデルファイルを読み込みました');
                };

                const handleImageFiles = (files) => {
                    if (!files.length) return;
                    const canAdd = Math.max(0, MAX_IMAGES - state.images.length);
                    const candidates = Array.from(files)
                        .filter((file) => file.type.startsWith('image/'))
                        .slice(0, canAdd);
                    if (!candidates.length) {
                        showToast('画像ファイルを選択してください。', true);
                        return;
                    }
                    candidates.forEach((file) => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            state.images.push({
                                id: uuid(),
                                name: file.name,
                                size: file.size,
                                file,
                                previewSrc: event.target.result,
                                status: 'pending',
                                results: [],
                                resultImage: null,
                                error: null,
                                duration: null,
                                numDetections: 0,
                            });
                            renderImageGrid();
                        };
                        reader.readAsDataURL(file);
                    });
                    if (files.length > candidates.length) {
                        showToast(`最大${MAX_IMAGES}枚まで登録できます。`, true);
                    } else {
                        showToast(`${candidates.length}件の画像を追加しました。`);
                    }
                };

                const downloadImage = (image) => {
                    if (!image.resultImage) {
                        showToast('推論後の画像がまだありません。', true);
                        return;
                    }
                    const link = document.createElement('a');
                    link.href = image.resultImage;
                    link.download = `result_${image.name}`;
                    link.click();
                };

                const resetWorkspace = () => {
                    state.images = [];
                    state.logs = [];
                    state.lastStats = null;
                    renderImageGrid();
                    renderLogs();
                    renderModelInfo();
                    showToast('画像と履歴をクリアしました');
                };

                const applyInferenceResults = (payload) => {
                    const resultMap = new Map();
                    (payload.results || []).forEach((item) => {
                        resultMap.set(item.image_id, item);
                    });

                    state.classNames = payload.class_names || state.classNames;
                    state.lastStats = payload.stats || null;
                    state.lastDevice = payload.device || '';

                    state.images.forEach((image) => {
                        const result = resultMap.get(image.id);
                        if (!result) {
                            image.status = 'error';
                            image.error = '結果が取得できませんでした';
                            image.resultImage = null;
                            image.results = [];
                            return;
                        }
                        image.status = 'completed';
                        image.results = result.detections || [];
                        image.resultImage = result.result_image || image.resultImage || image.previewSrc;
                        image.previewSrc = image.resultImage || image.previewSrc;
                        image.numDetections = result.num_detections ?? image.results.length;
                        image.duration = result.duration_ms ?? null;
                        image.error = null;
                    });

                    const stats = payload.stats || {};
                    const meta = `${new Date().toLocaleString()} / Device: ${payload.device || 'N/A'} / 検出 ${
                        stats.total_detections ?? 0
                    }件 / ${(Number(stats.total_time_ms ?? 0)).toFixed(1)} ms`;
                    state.logs.unshift({
                        id: uuid(),
                        title: `推論完了 (${stats.total_images ?? state.images.length}枚)`,
                        meta,
                    });
                    if (state.logs.length > 30) state.logs.pop();
                };

                const executeInference = async () => {
                    if (!state.model) {
                        showToast('まずモデルファイルを読み込んでください。', true);
                        return;
                    }
                    if (!state.images.length) {
                        showToast('推論したい画像を追加してください。', true);
                        return;
                    }
                    if (state.isRunning) return;

                    updateSettings();
                    state.isRunning = true;
                    elements.runBtn.disabled = true;
                    state.images.forEach((image) => {
                        image.status = 'running';
                        image.results = [];
                        image.error = null;
                        image.resultImage = image.resultImage || image.previewSrc;
                    });
                    renderImageGrid();
                    renderModelInfo();

                    const formData = new FormData();
                    formData.append('model', state.model.file, state.model.name);
                    Object.entries(state.settings).forEach(([key, value]) => {
                        formData.append(key, value);
                    });
                    formData.append(
                        'image_metadata',
                        JSON.stringify(state.images.map(({ id, name }) => ({ id, name }))),
                    );
                    state.images.forEach((image) => {
                        formData.append('images', image.file, image.name);
                    });

                    try {
                        const response = await fetch(RUN_ENDPOINT, { method: 'POST', body: formData });
                        const contentType = response.headers.get('content-type') || '';
                        const payload = contentType.includes('application/json') ? await response.json() : null;
                        if (!response.ok) {
                            const message = payload?.error || '推論API呼び出しに失敗しました。';
                            throw new Error(message);
                        }
                        applyInferenceResults(payload || {});
                        renderLogs();
                        renderModelInfo();
                        renderImageGrid();
                        showToast('推論が完了しました。');
                    } catch (error) {
                        state.images.forEach((image) => {
                            image.status = 'error';
                            image.error = error.message || '推論中にエラーが発生しました';
                        });
                        showToast(error.message || '推論に失敗しました。', true);
                        renderImageGrid();
                    } finally {
                        state.isRunning = false;
                        elements.runBtn.disabled = false;
                        renderModelInfo();
                    }
                };

                elements.modelDropzone.addEventListener('click', () => elements.modelInput.click());
                elements.modelDropzone.addEventListener('dragover', (evt) => {
                    evt.preventDefault();
                    elements.modelDropzone.classList.add('is-dragover');
                });
                elements.modelDropzone.addEventListener('dragleave', () =>
                    elements.modelDropzone.classList.remove('is-dragover'),
                );
                elements.modelDropzone.addEventListener('drop', (evt) => {
                    evt.preventDefault();
                    elements.modelDropzone.classList.remove('is-dragover');
                    handleModelFiles(evt.dataTransfer.files);
                });
                elements.modelInput.addEventListener('change', (evt) => {
                    handleModelFiles(evt.target.files);
                    elements.modelInput.value = '';
                });

                elements.imageDropzone.addEventListener('click', () => elements.imageInput.click());
                elements.imageDropzone.addEventListener('dragover', (evt) => {
                    evt.preventDefault();
                    elements.imageDropzone.classList.add('is-dragover');
                });
                elements.imageDropzone.addEventListener('dragleave', () =>
                    elements.imageDropzone.classList.remove('is-dragover'),
                );
                elements.imageDropzone.addEventListener('drop', (evt) => {
                    evt.preventDefault();
                    elements.imageDropzone.classList.remove('is-dragover');
                    handleImageFiles(evt.dataTransfer.files);
                });
                elements.imageInput.addEventListener('change', (evt) => {
                    handleImageFiles(evt.target.files);
                    elements.imageInput.value = '';
                });

                elements.settingsForm.addEventListener('input', updateSettings);
                elements.runBtn.addEventListener('click', executeInference);
                elements.resetBtn.addEventListener('click', resetWorkspace);

                renderModelInfo();
                renderImageGrid();
                renderLogs();
            })();
        </script>
    </body>
</html>
